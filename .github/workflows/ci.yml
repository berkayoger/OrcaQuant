name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package-lock.json'
              - 'frontend/package-lock.json'
            backend:
              - 'backend/**'
              - 'pyproject.toml'
              - 'requirements*.txt'
              - 'tests/**'

  frontend_tests:
    needs: [changes]
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install
        working-directory: frontend
        run: npm ci
      - name: Test
        working-directory: frontend
        run: npm test --if-present

  backend_tests:
    needs: [changes]
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version-file: .python-version
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
      - name: Pytest
        run: pytest -q
      - name: Mypy (fail fast)
        run: mypy backend

  security_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version-file: .python-version
      - name: Install audit tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety
      - name: pip-audit (fail fast)
        run: pip-audit -r requirements.txt
      - name: safety (fail fast)
        run: safety check -r requirements.txt

  deploy_staging:
    needs: [frontend_tests, backend_tests, security_scan]
    if: github.ref == 'refs/heads/main' && always() && needs.security_scan.result == 'success' && (needs.backend_tests.result == 'success' || needs.backend_tests.result == 'skipped') && (needs.frontend_tests.result == 'success' || needs.frontend_tests.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
      - name: Resolve staging manifests path (must exist)
        id: manifests
        run: |
          set -euo pipefail
          MANIFEST_PATH="deploy/k8s"
          test -d "$MANIFEST_PATH"
          echo "manifest_path=$MANIFEST_PATH" >> "$GITHUB_OUTPUT"
      - name: Deploy (staging)
        env:
          KUBECONFIG: ${{ secrets.STAGING_KUBECONFIG }}
        run: |
          set -euo pipefail
          kubectl get namespace orcaquant >/dev/null 2>&1 || kubectl create namespace orcaquant
          kubectl apply -n orcaquant -f "${{ steps.manifests.outputs.manifest_path }}"
      - name: Smoke test (staging)
        env:
          KUBECONFIG: ${{ secrets.STAGING_KUBECONFIG }}
        run: |
          set -euo pipefail
          kubectl -n orcaquant rollout status deploy/orcaquant --timeout=180s
