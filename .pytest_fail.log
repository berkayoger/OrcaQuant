============================= test session starts ==============================
platform linux -- Python 3.12.1, pytest-7.4.4, pluggy-1.6.0 -- /usr/local/python/3.12.1/bin/python3
cachedir: .pytest_cache
rootdir: /workspaces/ytd-kopya
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.9.0, Faker-37.5.3, cov-4.1.0
collecting ... collected 163 items

tests/test_admin_custom_features.py::test_admin_can_update_custom_features PASSED [  0%]
tests/test_admin_custom_features.py::test_update_custom_features_invalid_json PASSED [  1%]
tests/test_admin_custom_features.py::test_update_custom_features_user_not_found PASSED [  1%]
tests/test_admin_custom_features.py::test_update_custom_features_invalid_user_id PASSED [  2%]
tests/test_admin_draks_monitor.py::test_list_decisions PASSED            [  3%]
tests/test_admin_draks_monitor.py::test_list_signals PASSED              [  3%]
tests/test_admin_logs_api.py::test_get_logs PASSED                       [  4%]
tests/test_admin_logs_api.py::test_logs_filter_by_username PASSED        [  4%]
tests/test_admin_logs_api.py::test_logs_filter_by_action PASSED          [  5%]
tests/test_admin_logs_api.py::test_logs_date_range PASSED                [  6%]
tests/test_admin_logs_api.py::test_logs_pagination PASSED                [  6%]
tests/test_admin_plan_management.py::test_full_plan_crud_flow PASSED     [  7%]
tests/test_admin_plan_management.py::test_create_plan_missing_name PASSED [  7%]
tests/test_admin_plan_management.py::test_create_plan_invalid_limit_value PASSED [  8%]
tests/test_admin_plan_management.py::test_update_plan_limits_invalid_payload PASSED [  9%]
tests/test_admin_plan_management.py::test_delete_nonexistent_plan PASSED [  9%]
tests/test_admin_promo.py::test_update_expiration_success PASSED         [ 10%]
tests/test_admin_promo.py::test_update_expiration_past_date PASSED       [ 11%]
tests/test_admin_promo.py::test_promo_usage_stats PASSED                 [ 11%]
tests/test_admin_promo.py::test_promo_code_usage_details PASSED          [ 12%]
tests/test_admin_promo.py::test_get_user_promos PASSED                   [ 12%]
tests/test_admin_rbac_guard.py::test_admin_guard_forbids_without_admin FAILED [ 13%]

=================================== FAILURES ===================================
____________________ test_admin_guard_forbids_without_admin ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7880e978f470>

    def test_admin_guard_forbids_without_admin(monkeypatch):
        app = create_app()
        _add_dummy_admin_route(app)
    
        # JWT doğrulamasını no-op yap, roller boş kalsın
        monkeypatch.setattr(roles_mod, "verify_jwt_in_request", lambda optional=False: None)
        monkeypatch.setattr(roles_mod, "current_roles", lambda: set())
    
        client = app.test_client()
        resp = client.get("/api/admin/__rbac_test", headers={"Authorization": "Bearer test"})
>       assert resp.status_code == 403
E       assert 200 == 403
E        +  where 200 = <WrapperTestResponse streamed [200 OK]>.status_code

tests/test_admin_rbac_guard.py:22: AssertionError
----------------------------- Captured stderr call -----------------------------
{"asctime": "2025-08-25 22:55:16,736", "levelname": "INFO", "name": "backend", "message": "App booting with observability metrics enabled.", "pathname": "/workspaces/ytd-kopya/backend/__init__.py", "lineno": 161, "funcName": "create_app"}
{"asctime": "2025-08-25 22:55:16,794", "levelname": "INFO", "name": "backend", "message": "", "pathname": "/workspaces/ytd-kopya/backend/__init__.py", "lineno": 314, "funcName": "_after", "event": "http_access", "method": "GET", "path": "/api/admin/__rbac_test", "status": 200, "request_id": "01dcca5d-6dc9-42c1-91a6-4a81f5c9edd4", "user_id": "test-user", "remote_addr": "127.0.0.1", "latency_sec": 0.0001}
------------------------------ Captured log call -------------------------------
INFO     backend:__init__.py:161 App booting with observability metrics enabled.
INFO     backend:__init__.py:314 {'event': 'http_access', 'method': 'GET', 'path': '/api/admin/__rbac_test', 'status': 200, 'request_id': '01dcca5d-6dc9-42c1-91a6-4a81f5c9edd4', 'user_id': 'test-user', 'remote_addr': '127.0.0.1', 'latency_sec': 0.0001}
=========================== short test summary info ============================
FAILED tests/test_admin_rbac_guard.py::test_admin_guard_forbids_without_admin
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
================== 1 failed, 21 passed, 117 warnings in 5.13s ==================
