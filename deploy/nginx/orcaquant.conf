# /etc/nginx/sites-available/orcaquant.conf
# SSL/TLS + güvenlik başlıkları + Socket.IO uyumlu reverse proxy

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 80;
  server_name orcaquant.example.com www.orcaquant.example.com;

  # Certbot HTTP-01 challenge
  location /.well-known/acme-challenge/ { root /var/www/html; }
  location / { return 301 https://$host$request_uri; }
}

server {
  listen 443 ssl http2;
  server_name orcaquant.example.com www.orcaquant.example.com;

  # Sertifikalar (Certbot otomatik doldurur)
  ssl_certificate     /etc/letsencrypt/live/orcaquant.example.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/orcaquant.example.com/privkey.pem;
  ssl_protocols TLSv1.3 TLSv1.2;
  ssl_ciphers HIGH:!aNULL:!MD5;

  # Güvenlik başlıkları
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
  add_header X-Frame-Options DENY always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy no-referrer-when-downgrade always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
  add_header Content-Security-Policy-Report-Only "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self' https:; upgrade-insecure-requests" always;

  # Cloudflare/Proxy ardında doğru IP
  real_ip_header X-Forwarded-For;
  set_real_ip_from 0.0.0.0/0;

  # API için rate limit (limit_req_zone http seviyesinde tanımlı olmalı)
  location /api/ {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://127.0.0.1:5000;
    include /etc/nginx/snippets/proxy-params.conf;
  }

  # Flask uygulaması (genel)
  location / {
    proxy_pass http://127.0.0.1:5000;
    include /etc/nginx/snippets/proxy-params.conf;
    # SPA'ya geçişte history fallback gerekebilir
    # try_files $uri /index.html;
  }

  # WebSocket / Socket.IO
  location /socket.io/ {
    proxy_pass http://127.0.0.1:5000/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Statik dosyalar
  location /static/ {
    alias /opt/orcaquant/frontend/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
  }

  client_max_body_size 10M;
  include /etc/nginx/snippets/gzip.conf;
  access_log /var/log/nginx/orcaquant.access.log;
  error_log  /var/log/nginx/orcaquant.error.log;
}
